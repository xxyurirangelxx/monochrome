services:
    # Frontend de produção -- sempre inicia
    monochrome:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: monochrome
        ports:
            - '${MONOCHROME_PORT:-8080}:8080'
        environment:
            AUTH_ENABLED: ${AUTH_ENABLED:-false}
            AUTH_SECRET: ${AUTH_SECRET:-}
            FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID:-monochrome-database}
            FIREBASE_CONFIG: ${FIREBASE_CONFIG:-}
            POCKETBASE_URL: ${POCKETBASE_URL:-}
            SESSION_MAX_AGE: ${SESSION_MAX_AGE:-604800000}
        restart: unless-stopped
        networks:
            - monochrome-network
        healthcheck:
            test: [ 'CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8080/health' ]
            interval: 30s
            timeout: 3s
            retries: 3
            start_period: 5s

    # Backend PocketBase -- só inicia com: docker compose --profile pocketbase up -d
    pocketbase:
        image: ghcr.io/muchobien/pocketbase:latest
        container_name: monochrome-pocketbase
        profiles:
            - pocketbase
        restart: unless-stopped
        environment:
            PB_ADMIN_EMAIL: ${PB_ADMIN_EMAIL:-admin@example.com}
            PB_ADMIN_PASSWORD: ${PB_ADMIN_PASSWORD:-changeme}
            TZ: ${TZ:-America/Sao_Paulo}
        ports:
            - '${POCKETBASE_PORT:-7284}:8090'
        volumes:
            - pb_data:/pb_data
            - pb_public:/pb_public
            - pb_hooks:/pb_hooks
        command: serve --http=0.0.0.0:8090
        healthcheck:
            test: [ 'CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8090/api/health' ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s
        networks:
            - monochrome-network

    # Servidor de desenvolvimento -- só inicia com: docker compose --profile dev up -d
    monochrome-dev:
        build:
            context: .
            dockerfile: Dockerfile.dev
        container_name: monochrome-dev
        profiles:
            - dev
        ports:
            - '${MONOCHROME_DEV_PORT:-8080}:8080'
        volumes:
            - .:/app
            - /app/node_modules
        command: npm run dev -- --host 0.0.0.0 --port 8080
        networks:
            - monochrome-network

networks:
    monochrome-network:
        driver: bridge

volumes:
    pb_data:
    pb_public:
    pb_hooks:
